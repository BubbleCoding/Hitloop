<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configure Device</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.dom.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/simulation_styles.css') }}">
</head>
<body>
    <div id="page-title-container">
        <h1>Configure Device via WebSerial</h1>
    </div>

    <div id="config-container" class="ui-controls-panel" style="display: flex; flex-direction: column; gap: 15px;">
        
        <div>
            <label for="ssid">SSID:</label><br>
            <input type="text" id="ssid" name="ssid" class="p5-input">
        </div>

        <div>
            <label for="password">Password:</label><br>
            <input type="password" id="password" name="password" class="p5-input">
        </div>
        
        <div>
            <label for="serverUrl">Server URL:</label><br>
            <input type="text" id="serverUrl" name="serverUrl" class="p5-input">
        </div>
        
        <div>
            <input type="checkbox" id="erase" name="erase">
            <label for="erase">Erase configuration</label>
        </div>

        <button id="connect-button" class="p5-button">Connect</button>
        <button id="send-button" class="p5-button" disabled>Send Configuration</button>

        <div id="serial-output" style="width: 100%; height: 200px; background-color: #222; color: #0f0; font-family: monospace; overflow-y: scroll; padding: 10px; box-sizing: border-box; white-space: pre-wrap;">
            Serial output will appear here...
        </div>
    </div>

    <script>
        // WebSerial logic will go here
        const connectButton = document.getElementById('connect-button');
        const sendButton = document.getElementById('send-button');
        const serialOutput = document.getElementById('serial-output');
        const inputs = document.querySelectorAll('.p5-input, #erase');
        let port;
        let reader;

        function appendToSerial(text) {
            // Replace newline characters with <br> tags and append to innerHTML
            serialOutput.innerHTML += text.replace(/\r?\n/g, '<br>');
            serialOutput.scrollTop = serialOutput.scrollHeight;
        }

        connectButton.addEventListener('click', async () => {
            if (port) {
                // If disconnecting, cancel the reader first to unlock the stream
                if (reader) {
                    await reader.cancel();
                }
                await port.close();
                port = undefined;
                reader = undefined;
                connectButton.textContent = 'Connect';
                sendButton.disabled = true;
                inputs.forEach(input => input.disabled = true);
                appendToSerial('\n--- Port disconnected ---\n');
                return;
            }

            // If connecting
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                serialOutput.innerHTML = ''; // Clear the terminal on new connection
                appendToSerial('Serial port connected.\n');
                connectButton.textContent = 'Disconnect';
                sendButton.disabled = false;
                inputs.forEach(input => input.disabled = false);
                readFromPort(); // Start reading from the port
            } catch (err) {
                appendToSerial(`Error: ${err.message}`);
            }
        });

        sendButton.addEventListener('click', async () => {
            if (!port) {
                appendToSerial('\nError: Port not connected.\n');
                return;
            }
            sendConfiguration();
        });

        async function readFromPort() {
            const decoder = new TextDecoder();
            reader = port.readable.getReader();
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        break; // The port has been closed.
                    }
                    appendToSerial(decoder.decode(value, {stream: true}));
                }
            } catch (error) {
                // This error is expected when the user clicks "Disconnect"
                if (!(error instanceof DOMException && error.name === 'AbortError')) {
                    appendToSerial(`\n--- Read Error: ${error.message} ---\n`);
                }
            } finally {
                reader.releaseLock();
            }
        }

        async function sendConfiguration() {
            const writer = port.writable.getWriter();
            const erase = document.getElementById('erase').checked;
            
            let command = '';
            if(erase) {
                command = 'e\n';
            } else {
                const ssid = document.getElementById('ssid').value;
                const password = document.getElementById('password').value;
                const serverUrl = document.getElementById('serverUrl').value;
                // 'c' to configure, then the values separated by newlines
                command = `c\n${ssid}\n${password}\n${serverUrl}\n`;
            }

            await writer.write(new TextEncoder().encode(command));
            appendToSerial(`\n--- Sent Command: ---\n${command}\n---------------------\n`);
            writer.releaseLock();
        }

        // Disable inputs on page load
        document.addEventListener('DOMContentLoaded', () => {
            inputs.forEach(input => input.disabled = true);
        });
    </script>
</body>
</html> 