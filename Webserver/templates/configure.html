<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Web Serial Configuration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Configure ESP32 Scanner</h1>
    <div>
        <button id="openPortButton">Open Port</button>
        <button id="closePortButton" disabled>Close Port</button>
    </div>
    <hr>
    <div id="controls" style="pointer-events: none; opacity: 0.5;">
        <div>
            <label for="ssid">SSID:</label>
            <input type="text" id="ssid" name="ssid" required>
        </div>
        <div>
            <label for="password">Password:</label>
            <input type="password" id="password" name="password">
        </div>
        <div>
            <label for="serverUrl">Server URL:</label>
            <input type="text" id="serverUrl" name="serverUrl" value="http://192.168.1.165:5000/data" required>
        </div>
        <div>
            <input type="checkbox" id="eraseCheckbox">
            <label for="eraseCheckbox">Erase Configuration</label>
        </div>
        <button id="sendConfigButton">Send to Device</button>
    </div>
    <hr>
    <div id="log" style="background-color: #eee; padding: 10px; border: 1px solid #ccc; font-family: monospace; white-space: pre-wrap; height: 300px; overflow-y: scroll;"></div>

    <script>
        const openPortButton = document.getElementById('openPortButton');
        const closePortButton = document.getElementById('closePortButton');
        const sendConfigButton = document.getElementById('sendConfigButton');
        const eraseCheckbox = document.getElementById('eraseCheckbox');
        const controlsDiv = document.getElementById('controls');
        const logElement = document.getElementById('log');

        let port, reader, writer;
        let keepReading = false;

        function log(message, isRaw = false) {
            if (isRaw) {
                logElement.innerHTML += message.replace(/\r\n/g, '<br>').replace(/\n/g, '<br>');
            } else {
                logElement.innerHTML += `<strong>${message}</strong><br>`;
            }
            logElement.scrollTop = logElement.scrollHeight;
        }

        const readLoop = async () => {
            const decoder = new TextDecoder();
            while (port.readable && keepReading) {
                try {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const text = decoder.decode(value);
                    log(text, true);
                } catch (error) {
                    if (error.name !== 'AbortError') {
                         log(`Read loop error: ${error.message}`);
                    }
                    break;
                }
            }
        };

        openPortButton.addEventListener('click', async () => {
            logElement.innerHTML = '';
            log('Requesting serial port...');
            if (!('serial' in navigator)) {
                log('Web Serial API not supported.');
                return;
            }
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                keepReading = true;
                reader = port.readable.getReader();
                writer = port.writable.getWriter();
                
                readLoop();

                openPortButton.disabled = true;
                closePortButton.disabled = false;
                controlsDiv.style.pointerEvents = 'auto';
                controlsDiv.style.opacity = '1';
                log('Serial port opened.');
            } catch (error) {
                log(`Error opening port: ${error.message}`);
            }
        });

        closePortButton.addEventListener('click', async () => {
            if (!port) return;
            try {
                keepReading = false;
                await reader.cancel();
                await writer.close();
                await port.close();

                openPortButton.disabled = false;
                closePortButton.disabled = true;
                controlsDiv.style.pointerEvents = 'none';
                controlsDiv.style.opacity = '0.5';
                port = null;
                reader = null;
                writer = null;
                log('Serial port closed.');
            } catch (error) {
                log(`Error closing port: ${error.message}`);
            }
        });

        sendConfigButton.addEventListener('click', async () => {
            if (!port || !writer) {
                log('Port is not open.');
                return;
            }

            if (eraseCheckbox.checked) {
                log('--- Sending Erase Command ---');
                await writer.write(new TextEncoder().encode('e\\n'));
                log('Erase command sent. Device should restart.');
            } else {
                const ssid = document.getElementById('ssid').value;
                const password = document.getElementById('password').value;
                const serverUrl = document.getElementById('serverUrl').value;
                if (!ssid || !serverUrl) {
                    log('SSID and Server URL are required for configuration.');
                    return;
                }
                log('--- Sending Configure Command ---');
                await writer.write(new TextEncoder().encode('c\\n'));
                
                await new Promise(r => setTimeout(r, 100));
                log(`Sending SSID: ${ssid}`);
                await writer.write(new TextEncoder().encode(ssid + '\\n'));

                await new Promise(r => setTimeout(r, 100));
                log(`Sending Password: ${'*'.repeat(password.length)}`);
                await writer.write(new TextEncoder().encode(password + '\\n'));

                await new Promise(r => setTimeout(r, 100));
                log(`Sending Server URL: ${serverUrl}`);
                await writer.write(new TextEncoder().encode(serverUrl + '\\n'));
                log('Configuration data sent. Device should restart.');
            }
        });

        eraseCheckbox.addEventListener('change', (event) => {
            const inputs = ['ssid', 'password', 'serverUrl'];
            const isDisabled = event.currentTarget.checked;
            inputs.forEach(id => {
                document.getElementById(id).disabled = isDisabled;
            });
        });
    </script>
</body>
</html> 